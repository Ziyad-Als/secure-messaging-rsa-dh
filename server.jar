package cs285_project;

import java.net.ServerSocket;
import java.net.Socket;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.nio.charset.StandardCharsets;
import javax.crypto.Cipher;
import java.security.KeyPair;
import java.security.KeyPairGenerator;
import java.security.PublicKey;
import java.security.KeyFactory;
import java.security.spec.X509EncodedKeySpec;
import javax.crypto.KeyAgreement;
import java.util.Base64;

public class server {
    public static void main(String[] args) {
        try {
            // Generate RSA key pair
            KeyPairGenerator rsaKeyGen = KeyPairGenerator.getInstance("RSA");
            rsaKeyGen.initialize(2048);
            KeyPair rsaKeys = rsaKeyGen.generateKeyPair();

            // RSA Cipher for decryption
            Cipher rsaCipher = Cipher.getInstance("RSA/ECB/PKCS1Padding");
            rsaCipher.init(Cipher.DECRYPT_MODE, rsaKeys.getPrivate());

            // Waiting for client
            System.out.println("Waiting for clients...");
            ServerSocket ss = new ServerSocket(8000);
            Socket soc = ss.accept();
            System.out.println("Connection established");

            // Data streams
            DataOutputStream output = new DataOutputStream(soc.getOutputStream());
            DataInputStream input = new DataInputStream(soc.getInputStream());

            // Send RSA public key to client
            byte[] rsaPublicBytes = rsaKeys.getPublic().getEncoded();
            output.writeInt(rsaPublicBytes.length);
            output.write(rsaPublicBytes);
            output.flush();

            // Generate DH key pair
            KeyPairGenerator dhGenerator = KeyPairGenerator.getInstance("DH");
            dhGenerator.initialize(2048);
            KeyPair dhKeyPair = dhGenerator.generateKeyPair();

            // Send DH public key
            byte[] serverDhPublic = dhKeyPair.getPublic().getEncoded();
            output.writeInt(serverDhPublic.length);
            output.write(serverDhPublic);
            output.flush();

            // Receive client DH public key
            int clientDhKeyLength = input.readInt();
            byte[] clientDhPublicKeyBytes = new byte[clientDhKeyLength];
            input.readFully(clientDhPublicKeyBytes);

            // Convert client DH key
            KeyFactory dhKeyFactory = KeyFactory.getInstance("DH");
            X509EncodedKeySpec x509KeySpec = new X509EncodedKeySpec(clientDhPublicKeyBytes);
            PublicKey clientDhPublic = dhKeyFactory.generatePublic(x509KeySpec);

            // Perform DH key agreement
            KeyAgreement keyAgreement = KeyAgreement.getInstance("DH");
            keyAgreement.init(dhKeyPair.getPrivate());
            keyAgreement.doPhase(clientDhPublic, true);
            byte[] sharedSecret = keyAgreement.generateSecret();
            System.out.print("Shared secret bytes: ");
            for (int i = 0; i < sharedSecret.length; i++) {
            System.out.print(sharedSecret[i] + " ");
            }
            System.out.println("");

            // Receive encrypted message (Base64 string)
            String encryptedBase64 = input.readUTF();
            System.out.println("Received encrypted message (Base64): " + encryptedBase64);

            // Decode from Base64
            byte[] encrypted = Base64.getDecoder().decode(encryptedBase64);

            // Decrypt with RSA
            byte[] decryptedBytes = rsaCipher.doFinal(encrypted);
            String decryptedMessage = new String(decryptedBytes, StandardCharsets.UTF_8);

            System.out.println("Decrypted message from client: " + decryptedMessage);

        } catch (Exception e) {
            System.out.println("Error");
        }
    }
}
